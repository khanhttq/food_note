<!doctype html>
<html lang="vi">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <meta name="apple-mobile-web-app-status-bar-style" content="default" />
 <meta name="theme-color" content="#111827" />
 <title>Check-in App</title>
 <style>
   :root {
     --primary: #111827;
     --primary-light: #374151;
     --accent: #3b82f6;
     --success: #10b981;
     --warning: #f59e0b;
     --danger: #ef4444;
     --bg: #ffffff;
     --bg-soft: #f8fafc;
     --bg-card: #ffffff;
     --border: #e2e8f0;
     --border-focus: #3b82f6;
     --text: #0f172a;
     --text-soft: #64748b;
     --text-muted: #94a3b8;
     --text-xs: 14px;
     --text-sm: 16px;
     --text-base: 18px;
     --text-lg: 20px;
     --text-xl: 24px;
     --text-2xl: 28px;
     --tap-target: 48px;
     --space-1: 4px;
     --space-2: 8px;
     --space-3: 12px;
     --space-4: 16px;
     --space-6: 24px;
     --space-8: 32px;
     --container-padding: 16px;
     --card-padding: 20px;
     --input-padding: 16px;
     --radius-sm: 8px;
     --radius: 12px;
     --radius-lg: 16px;
     --radius-full: 9999px;
     --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
     --shadow: 0 4px 6px rgba(0,0,0,0.07);
     --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
   }

   *, *::before, *::after { box-sizing: border-box; }
   
   html {
     height: 100%;
     -webkit-text-size-adjust: 100%;
     -ms-text-size-adjust: 100%;
   }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
     background: var(--bg-soft);
     color: var(--text);
     margin: 0;
     min-height: 100%;
     font-size: var(--text-base);
     line-height: 1.5;
     padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
     overscroll-behavior-y: contain;
     -webkit-overflow-scrolling: touch;
   }

   .container {
     max-width: 100%;
     padding: var(--container-padding);
     margin: 0 auto;
   }

   .header {
     background: var(--primary);
     color: white;
     padding: var(--space-4) var(--container-padding);
     margin: calc(var(--container-padding) * -1) calc(var(--container-padding) * -1) var(--space-6);
     text-align: center;
   }
   
   .header h1 {
     margin: 0;
     font-size: var(--text-xl);
     font-weight: 600;
     letter-spacing: -0.025em;
   }

   .card {
     background: var(--bg-card);
     border-radius: var(--radius-lg);
     padding: var(--card-padding);
     box-shadow: var(--shadow);
     border: 1px solid var(--border);
     margin-bottom: var(--space-4);
   }

   .section-title {
     font-size: var(--text-lg);
     font-weight: 600;
     margin-bottom: var(--space-4);
     color: var(--text);
   }

   /* 🔥 TYPE SELECTOR */
   .type-selector {
     display: grid;
     grid-template-columns: repeat(3, 1fr);
     gap: var(--space-3);
     margin-bottom: var(--space-6);
   }

   .type-option {
     position: relative;
     cursor: pointer;
   }

   .type-input {
     position: absolute;
     opacity: 0;
     pointer-events: none;
   }

   .type-label {
     display: flex;
     flex-direction: column;
     align-items: center;
     padding: var(--space-4);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     background: var(--bg);
     transition: all 0.2s ease;
     min-height: 80px;
     justify-content: center;
   }

   .type-input:checked + .type-label {
     border-color: var(--accent);
     background: #f0f9ff;
     color: var(--accent);
   }

   .type-emoji {
     font-size: 24px;
     margin-bottom: var(--space-1);
   }

   .type-text {
     font-size: var(--text-sm);
     font-weight: 600;
   }

   /* 🔥 SEARCH SECTION */
   .search-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .search-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .input-group {
     position: relative;
     margin-bottom: var(--space-4);
   }

   .input-wrapper {
     position: relative;
     display: flex;
     align-items: center;
     background: var(--bg);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-2);
     transition: all 0.2s ease;
     min-height: var(--tap-target);
   }

   .input-wrapper:focus-within {
     border-color: var(--border-focus);
     box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
   }

   .input {
     flex: 1;
     border: none;
     outline: none;
     background: transparent;
     font-size: var(--text-base);
     padding: var(--space-3);
     color: var(--text);
     font-size: 16px;
   }

   .input::placeholder {
     color: var(--text-muted);
   }

   .search-status {
     display: flex;
     align-items: center;
     gap: var(--space-2);
     padding-right: var(--space-2);
   }

   .loading {
     width: 16px;
     height: 16px;
     border: 2px solid var(--border);
     border-top-color: var(--accent);
     border-radius: 50%;
     animation: spin 0.8s linear infinite;
     display: none;
   }

   .loading.show { display: block; }

   .badge {
     font-size: var(--text-xs);
     color: var(--text-soft);
     font-weight: 500;
     white-space: nowrap;
   }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }

   /* 🔥 DROPDOWN */
   .dropdown {
     position: relative;
   }

   .dropdown-menu {
     position: absolute;
     top: 100%;
     left: 0;
     right: 0;
     background: var(--bg-card);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     box-shadow: var(--shadow-lg);
     max-height: 40vh;
     overflow-y: auto;
     z-index: 50;
     margin-top: var(--space-2);
     display: none;
     -webkit-overflow-scrolling: touch;
   }

   .dropdown-menu.show {
     display: block;
   }

   .menu-item {
     padding: var(--input-padding);
     border-bottom: 1px solid var(--border);
     cursor: pointer;
     transition: background-color 0.15s ease;
     min-height: var(--tap-target);
     display: flex;
     flex-direction: column;
     justify-content: center;
   }

   .menu-item:last-child {
     border-bottom: none;
   }

   .menu-item:active,
   .menu-item.active {
     background: var(--bg-soft);
   }

   .menu-item-name {
     font-weight: 600;
     font-size: var(--text-base);
     color: var(--text);
     margin-bottom: var(--space-1);
   }

   .menu-item-meta {
     font-size: var(--text-sm);
     color: var(--text-soft);
   }

   .highlight {
     background: #fef3c7;
     font-weight: 600;
     padding: 1px 2px;
     border-radius: 2px;
   }

   /* 🔥 NOT FOUND OPTION */
   .not-found-section {
     border: 1px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-4);
     background: #fefce8;
     display: none;
   }

   .not-found-section.show {
     display: block;
     animation: fadeIn 0.3s ease;
   }

   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(-10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   .checkbox-wrapper {
     display: flex;
     align-items: center;
     gap: var(--space-3);
     margin-bottom: var(--space-4);
   }

   .checkbox {
     width: 20px;
     height: 20px;
     border: 2px solid var(--border);
     border-radius: 4px;
     cursor: pointer;
     position: relative;
     transition: all 0.2s ease;
   }

   .checkbox input {
     opacity: 0;
     position: absolute;
     pointer-events: none;
   }

   .checkbox input:checked + .checkmark {
     background: var(--accent);
     border-color: var(--accent);
   }

   .checkmark {
     width: 100%;
     height: 100%;
     border-radius: 4px;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     font-size: 12px;
   }

   .checkbox input:checked + .checkmark::after {
     content: '✓';
   }

   .checkbox-label {
     font-weight: 600;
     color: #92400e;
     cursor: pointer;
   }

   .manual-input {
     width: 100%;
     padding: var(--space-3);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     font-size: var(--text-base);
     transition: border-color 0.2s ease;
     display: none;
   }

   .manual-input.show {
     display: block;
   }

   .manual-input:focus {
     outline: none;
     border-color: var(--accent);
   }

   /* 🔥 REASON SELECTOR */
   .reason-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .reason-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .reason-options {
     display: flex;
     flex-direction: column;
     gap: var(--space-3);
     margin-bottom: var(--space-6);
   }

   .reason-option {
     display: flex;
     align-items: center;
     gap: var(--space-3);
     padding: var(--space-3);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .reason-option:hover {
     border-color: var(--accent);
   }

   .reason-option.selected {
     border-color: var(--accent);
     background: #f0f9ff;
   }

   .reason-icon {
     font-size: 20px;
     width: 24px;
     text-align: center;
   }

   .reason-text {
     font-weight: 500;
     flex: 1;
   }

   /* 🔥 PREVIEW SECTION */
   .preview-section {
     background: var(--bg-soft);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-6);
     display: none;
   }

   .preview-section.show {
     display: block;
     animation: slideIn 0.3s ease;
   }

   @keyframes slideIn {
     from { opacity: 0; transform: translateY(-10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   .preview-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: var(--space-3);
     padding-bottom: var(--space-2);
     border-bottom: 1px solid var(--border);
   }

   .preview-label {
     font-size: var(--text-sm);
     font-weight: 600;
     color: var(--text);
   }

   .preview-status {
     font-size: var(--text-xs);
     padding: var(--space-1) var(--space-2);
     border-radius: var(--radius-sm);
     font-weight: 500;
     background: #dcfce7;
     color: #166534;
   }

   .preview-content {
     display: flex;
     flex-direction: column;
     gap: var(--space-3);
   }

   .preview-item {
     display: flex;
     justify-content: space-between;
     align-items: flex-start;
     gap: var(--space-3);
   }

   .preview-field-label {
     font-size: var(--text-sm);
     color: var(--text-soft);
     font-weight: 500;
     min-width: 80px;
     flex-shrink: 0;
   }

   .preview-field-value {
     font-size: var(--text-sm);
     color: var(--text);
     font-weight: 500;
     flex: 1;
     text-align: right;
     word-break: break-word;
   }

   .preview-field-value.empty {
     color: var(--text-muted);
     font-style: italic;
   }

   /* 🔥 SUBMIT BUTTON */
   .submit-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .submit-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .btn {
     width: 100%;
     background: var(--primary);
     color: white;
     border: none;
     border-radius: var(--radius);
     padding: var(--input-padding);
     font-size: var(--text-base);
     font-weight: 600;
     min-height: var(--tap-target);
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: var(--space-2);
     touch-action: manipulation;
   }

   .btn:active {
     background: var(--primary-light);
     transform: scale(0.98);
   }

   .btn:disabled {
     opacity: 0.6;
     cursor: not-allowed;
     transform: none;
   }

   .btn.ready {
     background: var(--success);
   }

   .btn.ready:active {
     background: #059669;
   }

   /* 🔥 TOAST */
   .toast {
     position: fixed;
     bottom: var(--space-6);
     left: var(--container-padding);
     right: var(--container-padding);
     background: var(--primary);
     color: white;
     padding: var(--input-padding);
     border-radius: var(--radius);
     box-shadow: var(--shadow-lg);
     transform: translateY(100px);
     opacity: 0;
     transition: all 0.3s ease;
     z-index: 100;
     text-align: center;
     font-weight: 500;
   }

   .toast.show {
     transform: translateY(0);
     opacity: 1;
   }

   .toast.success {
     background: var(--success);
   }

   .toast.error {
     background: var(--danger);
   }

   .toast.warning {
     background: var(--warning);
   }

   /* Mobile optimizations */
   input, select, textarea {
     font-size: 16px !important;
   }

   input, textarea {
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
   }

   button, .menu-item, .btn, .type-label, .reason-option {
     min-height: 48px;
   }

   .btn, .menu-item, .preview-section, .type-label, .reason-option {
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
   }

   ::-webkit-scrollbar {
     width: 0px;
     background: transparent;
   }
 </style>
</head>
<body>
 <div class="container">
   <div class="header">
     <h1>🏫 Check-in System</h1>
   </div>

   <!-- 🔥 STEP 1: TYPE SELECTION -->
   <div class="card">
     <div class="section-title">1. Chọn loại người dùng</div>
     <div class="type-selector">
       <div class="type-option">
         <input type="radio" name="userType" value="staff" id="typeStaff" class="type-input">
         <label for="typeStaff" class="type-label">
           <div class="type-emoji">👨‍💼</div>
           <div class="type-text">Staff</div>
         </label>
       </div>
       <div class="type-option">
         <input type="radio" name="userType" value="student" id="typeStudent" class="type-input">
         <label for="typeStudent" class="type-label">
           <div class="type-emoji">🎓</div>
           <div class="type-text">Student</div>
         </label>
       </div>
       <div class="type-option">
         <input type="radio" name="userType" value="teacher" id="typeTeacher" class="type-input">
         <label for="typeTeacher" class="type-label">
           <div class="type-emoji">👨‍🏫</div>
           <div class="type-text">Teacher</div>
         </label>
       </div>
     </div>
   </div>

   <!-- 🔥 STEP 2: SEARCH -->
   <div class="card">
     <div class="search-section" id="searchSection">
       <div class="section-title">2. Tìm kiếm thông tin</div>
       <div class="input-group">
         <div class="dropdown">
           <div class="input-wrapper">
             <input 
               id="searchInput"
               class="input" 
               type="text" 
               placeholder="Nhập tên, email hoặc mã thẻ..."
               autocomplete="off"
               autocapitalize="off"
               autocorrect="off"
               spellcheck="false"
               disabled
             />
             <div class="search-status">
               <div id="loading" class="loading"></div>
               <span id="badge" class="badge"></span>
             </div>
           </div>
           <div id="dropdownMenu" class="dropdown-menu"></div>
         </div>
       </div>

       <!-- 🔥 NOT FOUND OPTION -->
       <div class="not-found-section" id="notFoundSection">
         <div class="checkbox-wrapper">
           <label class="checkbox">
             <input type="checkbox" id="notFoundCheckbox">
             <div class="checkmark"></div>
           </label>
           <label for="notFoundCheckbox" class="checkbox-label">
             ❌ Không có trong danh sách
           </label>
         </div>
         <input 
           type="text" 
           id="manualInput" 
           class="manual-input" 
           placeholder="Nhập tên đầy đủ..."
         />
       </div>
     </div>
   </div>

   <!-- 🔥 STEP 3: REASON SELECTION -->
   <div class="card">
     <div class="reason-section" id="reasonSection">
       <div class="section-title">3. Chọn lý do</div>
       <div class="reason-options">
         <div class="reason-option" data-reason="forgot_card">
           <div class="reason-icon">🤦‍♂️</div>
           <div class="reason-text">Quên mang thẻ</div>
         </div>
         <div class="reason-option" data-reason="broken_card">
           <div class="reason-icon">💳</div>
           <div class="reason-text">Thẻ lỗi</div>
         </div>
         <div class="reason-option" data-reason="no_card">
           <div class="reason-icon">❓</div>
           <div class="reason-text">Chưa có thẻ</div>
         </div>
       </div>
     </div>
   </div>

   <!-- 🔥 PREVIEW -->
   <div class="preview-section" id="previewSection">
     <div class="preview-header">
       <span class="preview-label">Thông tin sẽ gửi</span>
       <span class="preview-status">✅ Sẵn sàng</span>
     </div>
     <div class="preview-content">
       <div class="preview-item">
         <div class="preview-field-label">👤 Loại:</div>
         <div id="previewType" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">📝 Tên:</div>
         <div id="previewName" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">📧 Email:</div>
         <div id="previewEmail" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">💳 Thẻ:</div>
         <div id="previewCard" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">❓ Lý do:</div>
         <div id="previewReason" class="preview-field-value">-</div>
       </div>
     </div>
   </div>

   <!-- 🔥 SUBMIT -->
   <div class="submit-section" id="submitSection">
     <button id="submitBtn" class="btn">
       <span id="submitText">Check-in</span>
       <span id="submitIcon">🚀</span>
     </button>
   </div>
 </div>

 <div id="toast" class="toast"></div>

 <script>
   // 🔥 CONFIGURATION
   const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwIhA5NCMMWhBKTU69ZmwHkqeiRDOKOms4MzQ4R95B1IYn3HK56zva-mlmpaLuW6bxpJg/exec';
   
   // Global state
   let selectedType = null;
   let selectedRecord = null;
   let isManualEntry = false;
   let selectedReason = null;
   let isSubmitting = false;
   let searchCache = new Map();

   // DOM elements
   const searchSection = document.getElementById('searchSection');
   const searchInput = document.getElementById('searchInput');
   const dropdownMenu = document.getElementById('dropdownMenu');
   const notFoundSection = document.getElementById('notFoundSection');
   const notFoundCheckbox = document.getElementById('notFoundCheckbox');
   const manualInput = document.getElementById('manualInput');
   const reasonSection = document.getElementById('reasonSection');
   const previewSection = document.getElementById('previewSection');
   const submitSection = document.getElementById('submitSection');
   const submitBtn = document.getElementById('submitBtn');
   const submitText = document.getElementById('submitText');
   const submitIcon = document.getElementById('submitIcon');
   const loading = document.getElementById('loading');
   const badge = document.getElementById('badge');
   const toast = document.getElementById('toast');

   // Preview elements
   const previewType = document.getElementById('previewType');
   const previewName = document.getElementById('previewName');
   const previewEmail = document.getElementById('previewEmail');
   const previewCard = document.getElementById('previewCard');
   const previewReason = document.getElementById('previewReason');

   // 🔥 API CLASS
   class SheetsAPI {
     static async searchByType(userType, query, limit = 20) {
       try {
         if (!query || query.length < 2) {
           return { results: [], count: 0 };
         }
         
         return new Promise((resolve, reject) => {
           const callbackName = 'search_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
           
           console.log(`🔍 Searching ${userType}:`, query);
           
           const script = document.createElement('script');
           script.src = `${API_BASE_URL}?action=searchByType&type=${userType}&query=${encodeURIComponent(query)}&limit=${limit}&callback=${callbackName}&t=${Date.now()}`;
           script.id = callbackName;
           
           window[callbackName] = function(data) {
             console.log('✅ Search results:', data);
             
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             
             if (data && data.error) {
               reject(new Error(data.error));
             } else {
               resolve(data);
             }
           };
           
           script.onerror = function() {
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             reject(new Error('Search failed'));
           };
           
           document.head.appendChild(script);
           
           setTimeout(() => {
             if (window[callbackName]) {
               delete window[callbackName];
               const scriptEl = document.getElementById(callbackName);
               if (scriptEl) document.head.removeChild(scriptEl);
               reject(new Error('Search timeout'));
             }
           }, 10000);
         });
       } catch (error) {
         console.error('Search error:', error);
         throw error;
       }
     }
     
     static async submitCheckin(data) {
       return new Promise((resolve, reject) => {
         console.log('🔥 Submitting checkin:', data);
         
         const timestamp = Date.now();
         const formId = 'checkin_form_' + timestamp;
         const iframeId = 'checkin_iframe_' + timestamp;
         
         const form = document.createElement('form');
         form.id = formId;
         form.method = 'POST';
         form.action = API_BASE_URL;
         form.target = iframeId;
         form.style.display = 'none';
         
         const iframe = document.createElement('iframe');
         iframe.id = iframeId;
         iframe.name = iframeId;
         iframe.style.display = 'none';
         
         const dataInput = document.createElement('input');
         dataInput.type = 'hidden';
         dataInput.name = 'data';
         dataInput.value = JSON.stringify({
           action: 'checkin',
           ...data,
           timestamp: new Date().toISOString()
         });
         
         form.appendChild(dataInput);
         document.body.appendChild(form);
         document.body.appendChild(iframe);
         
         let isCompleted = false;
         
         iframe.addEventListener('load', function() {
           if (!isCompleted) {
             isCompleted = true;
             setTimeout(() => {
               try {
                 if (form.parentNode) document.body.removeChild(form);
                 if (iframe.parentNode) document.body.removeChild(iframe);
               } catch (e) {}
             }, 1000);
             resolve({ success: true, message: 'Check-in thành công!' });
           }
         });
         
         setTimeout(() => {
           if (!isCompleted) {
             isCompleted = true;
             try {
               if (form.parentNode) document.body.removeChild(form);
               if (iframe.parentNode) document.body.removeChild(iframe);
             } catch (e) {}
             resolve({ success: true, message: 'Check-in đã gửi' });
           }
         }, 10000);
         
         form.submit();
       });
     }
   }

   // 🔥 UTILITY FUNCTIONS
   const showLoading = (show = true) => {
     loading.classList.toggle('show', show);
   };

   const showToast = (message, type = 'default') => {
     toast.textContent = message;
     toast.className = `toast ${type}`;
     toast.classList.add('show');
     
     setTimeout(() => {
       toast.classList.remove('show');
     }, 3000);
   };

   const normalize = (str) => {
     if (!str) return '';
     return str.toString()
       .normalize('NFD')
       .replace(/[\u0300-\u036f]/g, '')
       .replace(/đ/g, 'd')
       .replace(/Đ/g, 'd')
       .toLowerCase()
       .trim();
   };

   const highlightText = (text, query) => {
     if (!query || !text) return text || '(Không có tên)';
     const regex = new RegExp(`(${query.split(' ').filter(w => w.length > 1).join('|')})`, 'gi');
     return text.replace(regex, '<span class="highlight">$1</span>');
   };

   const formatRecord = (record) => {
     const parts = [record.name, record.email, record.card].filter(Boolean);
     return parts.join(' | ');
   };

   // 🔥 UI STATE MANAGEMENT
   const enableSection = (section, enabled = true) => {
     if (enabled) {
       section.classList.add('enabled');
       const inputs = section.querySelectorAll('input, button');
       inputs.forEach(input => input.disabled = false);
     } else {
       section.classList.remove('enabled');
       const inputs = section.querySelectorAll('input, button');
       inputs.forEach(input => input.disabled = true);
     }
   };

   const updatePreview = () => {
     const hasData = selectedType && (selectedRecord || (isManualEntry && manualInput.value.trim())) && selectedReason;
     
     if (hasData) {
       previewSection.classList.add('show');
       
       // Update preview content
       previewType.textContent = getTypeLabel(selectedType);
       
       if (selectedRecord) {
         previewName.textContent = selectedRecord.name || '-';
         previewEmail.textContent = selectedRecord.email || '-';
         previewCard.textContent = selectedRecord.card || '-';
       } else if (isManualEntry) {
         previewName.textContent = manualInput.value.trim() || '-';
         previewEmail.textContent = '-';
         previewCard.textContent = '-';
       }
       
       previewReason.textContent = getReasonLabel(selectedReason);
       
       // Enable submit
       enableSection(submitSection, true);
       submitBtn.classList.add('ready');
     } else {
       previewSection.classList.remove('show');
       enableSection(submitSection, false);
       submitBtn.classList.remove('ready');
     }
   };

   const getTypeLabel = (type) => {
     const labels = {
       staff: '👨‍💼 Staff',
       student: '🎓 Student', 
       teacher: '👨‍🏫 Teacher'
     };
     return labels[type] || type;
   };

   const getReasonLabel = (reason) => {
     const labels = {
       forgot_card: '🤦‍♂️ Quên mang thẻ',
       broken_card: '💳 Thẻ lỗi',
       no_card: '❓ Chưa có thẻ'
     };
     return labels[reason] || reason;
   };

   // 🔥 SEARCH FUNCTIONALITY
   const performSearch = async (query) => {
     if (!selectedType || !query || query.length < 2) {
       dropdownMenu.classList.remove('show');
       badge.textContent = '';
       return;
     }

     const cacheKey = `${selectedType}:${query}`;
     if (searchCache.has(cacheKey)) {
       renderResults(searchCache.get(cacheKey), query);
       return;
     }

     try {
       showLoading(true);
       const result = await SheetsAPI.searchByType(selectedType, query);
       
       searchCache.set(cacheKey, result.results || []);
       renderResults(result.results || [], query);
       badge.textContent = result.count ? `${result.count} kết quả` : 'Không tìm thấy';
       
       // Show not found option if no results
       if (!result.results || result.results.length === 0) {
         notFoundSection.classList.add('show');
       } else {
         notFoundSection.classList.remove('show');
         notFoundCheckbox.checked = false;
         isManualEntry = false;
         manualInput.classList.remove('show');
       }
       
     } catch (error) {
       console.error('Search error:', error);
       showToast('Lỗi tìm kiếm: ' + error.message, 'error');
       badge.textContent = 'Lỗi tìm kiếm';
     } finally {
       showLoading(false);
     }
   };

   const renderResults = (results, query) => {
     const fragment = document.createDocumentFragment();
     
     results.forEach((record, index) => {
       const item = document.createElement('div');
       item.className = 'menu-item';
       item.setAttribute('data-index', index);
       
       const name = highlightText(record.name, query);
       const email = highlightText(record.email, query);
       const card = highlightText(record.card, query);
       
       const metaParts = [email, card].filter(p => p && p !== '(Không có tên)');
       const meta = metaParts.length > 0 ? metaParts.join(' • ') : '';
       
       item.innerHTML = `
         <div class="menu-item-name">${name}</div>
         ${meta ? `<div class="menu-item-meta">${meta}</div>` : ''}
       `;
       
       item.addEventListener('click', (e) => {
         e.preventDefault();
         selectRecord(record);
       });
       
       fragment.appendChild(item);
     });

     dropdownMenu.innerHTML = '';
     dropdownMenu.appendChild(fragment);
     
     if (results.length > 0) {
       dropdownMenu.classList.add('show');
     } else {
       dropdownMenu.classList.remove('show');
     }
   };

   const selectRecord = (record) => {
     selectedRecord = record;
     searchInput.value = formatRecord(record);
     dropdownMenu.classList.remove('show');
     notFoundSection.classList.remove('show');
     notFoundCheckbox.checked = false;
     isManualEntry = false;
     manualInput.classList.remove('show');
     
     enableSection(reasonSection, true);
     updatePreview();
   };

   const debounce = (func, delay = 300) => {
     let timeoutId;
     return (...args) => {
       clearTimeout(timeoutId);
       timeoutId = setTimeout(() => func.apply(null, args), delay);
     };
   };

   const debouncedSearch = debounce(performSearch, 300);

   // 🔥 EVENT LISTENERS

   // Type selection
   document.querySelectorAll('input[name="userType"]').forEach(radio => {
     radio.addEventListener('change', (e) => {
       selectedType = e.target.value;
       console.log('Selected type:', selectedType);
       
       // Enable search section
       enableSection(searchSection, true);
       searchInput.focus();
       
       // Reset search
       searchInput.value = '';
       selectedRecord = null;
       dropdownMenu.classList.remove('show');
       notFoundSection.classList.remove('show');
       
       // Reset subsequent sections
       enableSection(reasonSection, false);
       enableSection(submitSection, false);
       selectedReason = null;
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
       
       updatePreview();
     });
   });

   // Search input
   searchInput.addEventListener('input', (e) => {
     const query = e.target.value.trim();
     selectedRecord = null;
     debouncedSearch(query);
     updatePreview();
   });

   searchInput.addEventListener('focus', () => {
     if (dropdownMenu.children.length > 0) {
       dropdownMenu.classList.add('show');
     }
   });

   searchInput.addEventListener('blur', () => {
     setTimeout(() => dropdownMenu.classList.remove('show'), 150);
   });

   // Not found checkbox
   notFoundCheckbox.addEventListener('change', (e) => {
     isManualEntry = e.target.checked;
     
     if (isManualEntry) {
       manualInput.classList.add('show');
       manualInput.focus();
       selectedRecord = null;
       enableSection(reasonSection, true);
     } else {
       manualInput.classList.remove('show');
       manualInput.value = '';
       enableSection(reasonSection, false);
       selectedReason = null;
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
     }
     
     updatePreview();
   });

   // Manual input
   manualInput.addEventListener('input', () => {
     updatePreview();
   });

   // Reason selection
   document.querySelectorAll('.reason-option').forEach(option => {
     option.addEventListener('click', () => {
       // Remove previous selection
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
       
       // Select current
       option.classList.add('selected');
       selectedReason = option.dataset.reason;
       
       console.log('Selected reason:', selectedReason);
       updatePreview();
     });
   });

   // Submit button
   submitBtn.addEventListener('click', async () => {
     if (isSubmitting) return;
     
     if (!selectedType || !selectedReason) {
       showToast('Vui lòng hoàn thành tất cả thông tin', 'error');
       return;
     }

     if (!selectedRecord && !isManualEntry) {
       showToast('Vui lòng chọn người hoặc đánh dấu "Không có trong danh sách"', 'error');
       return;
     }

     if (isManualEntry && !manualInput.value.trim()) {
       showToast('Vui lòng nhập tên', 'error');
       manualInput.focus();
       return;
     }

     isSubmitting = true;
     submitBtn.disabled = true;
     submitText.textContent = 'Đang gửi...';
     submitIcon.textContent = '⏳';
     showLoading(true);

     try {
       const checkinData = {
         userType: selectedType,
         reason: selectedReason,
         timestamp: new Date().toISOString()
       };

       if (selectedRecord) {
         checkinData.selectedRecord = selectedRecord;
         checkinData.inputMethod = 'selected';
       } else if (isManualEntry) {
         checkinData.manualName = manualInput.value.trim();
         checkinData.inputMethod = 'manual';
       }

       console.log('Submitting checkin data:', checkinData);
       
       const result = await SheetsAPI.submitCheckin(checkinData);
       
       if (result.success) {
         showToast(result.message, 'success');
         
         // Reset form
         resetForm();
       } else {
         showToast('Lỗi: ' + (result.error || 'Không xác định'), 'error');
       }

     } catch (error) {
       console.error('Submit error:', error);
       showToast('Lỗi: ' + error.message, 'error');
     } finally {
       isSubmitting = false;
       submitBtn.disabled = false;
       submitText.textContent = 'Check-in';
       submitIcon.textContent = '🚀';
       showLoading(false);
     }
   });

   // 🔥 RESET FORM
   const resetForm = () => {
     // Reset type selection
     document.querySelectorAll('input[name="userType"]').forEach(radio => radio.checked = false);
     selectedType = null;
     
     // Reset search
     searchInput.value = '';
     searchInput.disabled = true;
     selectedRecord = null;
     dropdownMenu.classList.remove('show');
     
     // Reset not found
     notFoundSection.classList.remove('show');
     notFoundCheckbox.checked = false;
     manualInput.classList.remove('show');
     manualInput.value = '';
     isManualEntry = false;
     
     // Reset reason
     document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
     selectedReason = null;
     
     // Reset sections
     enableSection(searchSection, false);
     enableSection(reasonSection, false);
     enableSection(submitSection, false);
     
     // Reset preview
     previewSection.classList.remove('show');
     submitBtn.classList.remove('ready');
     
     // Clear cache
     searchCache.clear();
     badge.textContent = '';
   };

   // 🔥 INITIALIZATION
   const initializeApp = () => {
     console.log('🚀 Initializing check-in app...');
     
     // Set initial state
     enableSection(searchSection, false);
     enableSection(reasonSection, false);
     enableSection(submitSection, false);
     
     showToast('Chọn loại người dùng để bắt đầu', 'success');
   };

   // Start app
   if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initializeApp);
   } else {
     initializeApp();
   }

   // PWA behaviors
   let lastTouchEnd = 0;
   document.addEventListener('touchend', (e) => {
     const now = Date.now();
     if (now - lastTouchEnd <= 300) {
       e.preventDefault();
     }
     lastTouchEnd = now;
   }, false);

   // Global error handling
   window.addEventListener('error', (event) => {
     console.error('💥 Global error:', event.error);
   });

   window.addEventListener('unhandledrejection', (event) => {
     console.error('💥 Unhandled promise rejection:', event.reason);
   });
 </script>
</body>
</html>