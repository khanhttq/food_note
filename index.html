<!doctype html>
<html lang="vi">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <meta name="apple-mobile-web-app-status-bar-style" content="default" />
 <meta name="theme-color" content="#111827" />
 <title>Search App</title>
 <style>
   :root {
     --primary: #111827;
     --primary-light: #374151;
     --accent: #3b82f6;
     --success: #10b981;
     --warning: #f59e0b;
     --danger: #ef4444;
     --bg: #ffffff;
     --bg-soft: #f8fafc;
     --bg-card: #ffffff;
     --border: #e2e8f0;
     --border-focus: #3b82f6;
     --text: #0f172a;
     --text-soft: #64748b;
     --text-muted: #94a3b8;
     --text-xs: 14px;
     --text-sm: 16px;
     --text-base: 18px;
     --text-lg: 20px;
     --text-xl: 24px;
     --text-2xl: 28px;
     --tap-target: 48px;
     --space-1: 4px;
     --space-2: 8px;
     --space-3: 12px;
     --space-4: 16px;
     --space-6: 24px;
     --space-8: 32px;
     --container-padding: 16px;
     --card-padding: 20px;
     --input-padding: 16px;
     --radius-sm: 8px;
     --radius: 12px;
     --radius-lg: 16px;
     --radius-full: 9999px;
     --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
     --shadow: 0 4px 6px rgba(0,0,0,0.07);
     --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
   }

   *, *::before, *::after { box-sizing: border-box; }
   
   html {
     height: 100%;
     -webkit-text-size-adjust: 100%;
     -ms-text-size-adjust: 100%;
   }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
     background: var(--bg-soft);
     color: var(--text);
     margin: 0;
     min-height: 100%;
     font-size: var(--text-base);
     line-height: 1.5;
     padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
     overscroll-behavior-y: contain;
     -webkit-overflow-scrolling: touch;
   }

   .container {
     max-width: 100%;
     padding: var(--container-padding);
     margin: 0 auto;
   }

   .header {
     background: var(--primary);
     color: white;
     padding: var(--space-4) var(--container-padding);
     margin: calc(var(--container-padding) * -1) calc(var(--container-padding) * -1) var(--space-6);
     text-align: center;
   }
   
   .header h1 {
     margin: 0;
     font-size: var(--text-xl);
     font-weight: 600;
     letter-spacing: -0.025em;
   }

   .card {
     background: var(--bg-card);
     border-radius: var(--radius-lg);
     padding: var(--card-padding);
     box-shadow: var(--shadow);
     border: 1px solid var(--border);
   }

   .input-group {
     position: relative;
     margin-bottom: var(--space-6);
   }

   .input-wrapper {
     position: relative;
     display: flex;
     align-items: center;
     background: var(--bg);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-2);
     transition: all 0.2s ease;
     min-height: var(--tap-target);
   }

   .input-wrapper:focus-within {
     border-color: var(--border-focus);
     box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
   }

   .input {
     flex: 1;
     border: none;
     outline: none;
     background: transparent;
     font-size: var(--text-base);
     padding: var(--space-3);
     color: var(--text);
     font-size: 16px;
   }

   .input::placeholder {
     color: var(--text-muted);
   }

   .search-status {
     display: flex;
     align-items: center;
     gap: var(--space-2);
     padding-right: var(--space-2);
   }

   .loading {
     width: 16px;
     height: 16px;
     border: 2px solid var(--border);
     border-top-color: var(--accent);
     border-radius: 50%;
     animation: spin 0.8s linear infinite;
     display: none;
   }

   .loading.show { display: block; }

   .badge {
     font-size: var(--text-xs);
     color: var(--text-soft);
     font-weight: 500;
     white-space: nowrap;
   }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }

   .dropdown {
     position: relative;
   }

   .dropdown-menu {
     position: absolute;
     top: 100%;
     left: 0;
     right: 0;
     background: var(--bg-card);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     box-shadow: var(--shadow-lg);
     max-height: 60vh;
     overflow-y: auto;
     z-index: 50;
     margin-top: var(--space-2);
     display: none;
     -webkit-overflow-scrolling: touch;
     overscroll-behavior: contain;
   }

   .dropdown-menu.show {
     display: block;
   }

   .menu-item {
     padding: var(--input-padding);
     border-bottom: 1px solid var(--border);
     cursor: pointer;
     transition: background-color 0.15s ease;
     min-height: var(--tap-target);
     display: flex;
     flex-direction: column;
     justify-content: center;
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
   }

   .menu-item:last-child {
     border-bottom: none;
   }

   .menu-item:active,
   .menu-item.active {
     background: var(--bg-soft);
   }

   .menu-item-name {
     font-weight: 600;
     font-size: var(--text-base);
     color: var(--text);
     margin-bottom: var(--space-1);
   }

   .menu-item-meta {
     font-size: var(--text-sm);
     color: var(--text-soft);
     line-height: 1.4;
   }

   .highlight {
     background: #fef3c7;
     font-weight: 600;
     padding: 1px 2px;
     border-radius: 2px;
   }

   .preview-section {
     background: var(--bg-soft);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-6);
     display: none;
   }

   .preview-section.show {
     display: block;
     animation: slideIn 0.3s ease;
   }

   @keyframes slideIn {
     from {
       opacity: 0;
       transform: translateY(-10px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   .preview-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: var(--space-3);
     padding-bottom: var(--space-2);
     border-bottom: 1px solid var(--border);
   }

   .preview-label {
     font-size: var(--text-sm);
     font-weight: 600;
     color: var(--text);
   }

   .preview-type {
     font-size: var(--text-xs);
     padding: var(--space-1) var(--space-2);
     border-radius: var(--radius-sm);
     font-weight: 500;
   }

   .preview-type.selected {
     background: #dcfce7;
     color: #166534;
   }

   .preview-type.typed {
     background: #fef3c7;
     color: #92400e;
   }

   .preview-content {
     display: flex;
     flex-direction: column;
     gap: var(--space-3);
   }

   .preview-item {
     display: flex;
     justify-content: space-between;
     align-items: flex-start;
     gap: var(--space-3);
   }

   .preview-field-label {
     font-size: var(--text-sm);
     color: var(--text-soft);
     font-weight: 500;
     min-width: 80px;
     flex-shrink: 0;
   }

   .preview-field-value {
     font-size: var(--text-sm);
     color: var(--text);
     font-weight: 500;
     flex: 1;
     text-align: right;
     word-break: break-word;
   }

   .preview-field-value.empty {
     color: var(--text-muted);
     font-style: italic;
   }

   .preview-divider {
     height: 1px;
     background: var(--border);
     margin: var(--space-2) 0;
   }

   .preview-selected {
     padding-top: var(--space-2);
   }

   .btn {
     width: 100%;
     background: var(--primary);
     color: white;
     border: none;
     border-radius: var(--radius);
     padding: var(--input-padding);
     font-size: var(--text-base);
     font-weight: 600;
     min-height: var(--tap-target);
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: var(--space-2);
     touch-action: manipulation;
   }

   .btn:active {
     background: var(--primary-light);
     transform: scale(0.98);
   }

   .btn:disabled {
     opacity: 0.6;
     cursor: not-allowed;
     transform: none;
   }

   .btn.ready {
     background: var(--success);
   }

   .btn.ready:active {
     background: #059669;
   }

   .toast {
     position: fixed;
     bottom: var(--space-6);
     left: var(--container-padding);
     right: var(--container-padding);
     background: var(--primary);
     color: white;
     padding: var(--input-padding);
     border-radius: var(--radius);
     box-shadow: var(--shadow-lg);
     transform: translateY(100px);
     opacity: 0;
     transition: all 0.3s ease;
     z-index: 100;
     text-align: center;
     font-weight: 500;
   }

   .toast.show {
     transform: translateY(0);
     opacity: 1;
   }

   .toast.success {
     background: var(--success);
   }

   .toast.error {
     background: var(--danger);
   }

   .toast.warning {
     background: var(--warning);
   }

   input, select, textarea {
     font-size: 16px !important;
   }

   input, textarea {
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
   }

   button, .menu-item, .btn {
     min-height: 48px;
   }

   .btn, .menu-item, .preview-section {
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
   }

   ::-webkit-scrollbar {
     width: 0px;
     background: transparent;
   }
 </style>
</head>
<body>
 <div class="container">
   <div class="header">
     <h1>üîç T√¨m ki·∫øm th√¥ng tin</h1>
   </div>

   <div class="card">
     <div class="input-group">
       <div class="dropdown">
         <div class="input-wrapper">
           <input 
             id="searchInput"
             class="input" 
             type="text" 
             placeholder="Nh·∫≠p t√™n, email ho·∫∑c m√£ th·∫ª..."
             autocomplete="off"
             autocapitalize="off"
             autocorrect="off"
             spellcheck="false"
           />
           <div class="search-status">
             <div id="loading" class="loading"></div>
             <span id="badge" class="badge"></span>
           </div>
         </div>
         <div id="dropdownMenu" class="dropdown-menu"></div>
       </div>
     </div>

     <div id="previewSection" class="preview-section">
       <div class="preview-header">
         <span class="preview-label">Th√¥ng tin s·∫Ω g·ª≠i</span>
         <span id="previewType" class="preview-type"></span>
       </div>
       <div id="previewContent" class="preview-content">
         <div class="preview-item">
           <div class="preview-field-label">N·ªôi dung nh·∫≠p:</div>
           <div id="previewInput" class="preview-field-value">-</div>
         </div>
         <div id="previewSelected" class="preview-selected" style="display: none;">
           <div class="preview-divider"></div>
           <div class="preview-item">
             <div class="preview-field-label">üë§ T√™n:</div>
             <div id="previewName" class="preview-field-value">-</div>
           </div>
           <div class="preview-item">
             <div class="preview-field-label">üìß Email:</div>
             <div id="previewEmail" class="preview-field-value">-</div>
           </div>
           <div class="preview-item">
             <div class="preview-field-label">üí≥ Th·∫ª:</div>
             <div id="previewCard" class="preview-field-value">-</div>
           </div>
         </div>
       </div>
     </div>

     <button id="submitBtn" class="btn">
       <span id="submitText">G·ª≠i th√¥ng tin</span>
       <span id="submitIcon">üì§</span>
     </button>
   </div>
 </div>

 <div id="toast" class="toast"></div>

 <script>
   // üî• CONFIGURATION - UPDATE WITH YOUR ACTUAL URL
   const API_BASE_URL = 'https://script.google.com/macros/s/AKfycby5lURMPxwKDOTvyQC8VlIgIo0NIzczgyTs1RH8wXjwmjHXsSvBFZ7QcJ9ysPu8v3o7rQ/exec';
   
   // Global variables
   let dataset = [];
   let filteredResults = [];
   let selectedRecord = null;
   let activeIndex = -1;
   let isSubmitting = false;
   let searchCache = new Map();

   // DOM elements
   const searchInput = document.getElementById('searchInput');
   const dropdownMenu = document.getElementById('dropdownMenu');
   const previewSection = document.getElementById('previewSection');
   const previewType = document.getElementById('previewType');
   const previewInput = document.getElementById('previewInput');
   const previewSelected = document.getElementById('previewSelected');
   const previewName = document.getElementById('previewName');
   const previewEmail = document.getElementById('previewEmail');
   const previewCard = document.getElementById('previewCard');
   const submitBtn = document.getElementById('submitBtn');
   const submitText = document.getElementById('submitText');
   const submitIcon = document.getElementById('submitIcon');
   const toast = document.getElementById('toast');
   const loading = document.getElementById('loading');
   const badge = document.getElementById('badge');

   // üî• PURE FORM API - 100% NO CORS ISSUES
   class SheetsAPI {
     // GET v·ªõi JSONP (kh√¥ng CORS)
     static async getData() {
       try {
         return new Promise((resolve, reject) => {
           const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
           
           console.log('üî• JSONP request v·ªõi callback:', callbackName);
           
           const script = document.createElement('script');
           script.src = `${API_BASE_URL}?action=getData&callback=${callbackName}&t=${Date.now()}`;
           script.id = callbackName;
           
           window[callbackName] = function(data) {
             console.log('‚úÖ JSONP callback received:', data);
             
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             
             if (data && data.error) {
               reject(new Error(data.error));
             } else {
               resolve(data || []);
             }
           };
           
           script.onerror = function() {
             console.error('‚ùå JSONP script failed');
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             reject(new Error('Failed to load data from server'));
           };
           
           document.head.appendChild(script);
           
           setTimeout(() => {
             if (window[callbackName]) {
               delete window[callbackName];
               const scriptEl = document.getElementById(callbackName);
               if (scriptEl) document.head.removeChild(scriptEl);
               reject(new Error('Request timeout after 30 seconds'));
             }
           }, 30000);
         });
       } catch (error) {
         console.error('API getData Error:', error);
         throw error;
       }
     }
     
     // üî• POST v·ªõi Pure Form - KH√îNG BAO GI·ªú B·ªä CORS
     static async saveResponse(inputText, selectedRecord) {
       return new Promise((resolve, reject) => {
         console.log('üî• Pure Form Submission - Zero CORS risk!');
         console.log('üìù Data:', { inputText, selectedRecord });
         
         // T·∫°o unique IDs
         const timestamp = Date.now();
         const formId = 'form_' + timestamp;
         const iframeId = 'iframe_' + timestamp;
         
         // T·∫°o hidden form
         const form = document.createElement('form');
         form.id = formId;
         form.method = 'POST';
         form.action = API_BASE_URL;
         form.target = iframeId;
         form.style.display = 'none';
         form.enctype = 'application/x-www-form-urlencoded';
         
         // T·∫°o hidden iframe
         const iframe = document.createElement('iframe');
         iframe.id = iframeId;
         iframe.name = iframeId;
         iframe.style.display = 'none';
         iframe.style.width = '0';
         iframe.style.height = '0';
         iframe.style.border = 'none';
         
         // T·∫°o input v·ªõi JSON data
         const dataInput = document.createElement('input');
         dataInput.type = 'hidden';
         dataInput.name = 'data';
         dataInput.value = JSON.stringify({
           action: 'saveResponse',
           inputText: inputText,
           selectedRecord: selectedRecord,
           timestamp: new Date().toISOString(),
           userAgent: navigator.userAgent,
           formId: formId
         });
         
         console.log('üì§ Form payload:', dataInput.value);
         
         form.appendChild(dataInput);
         document.body.appendChild(form);
         document.body.appendChild(iframe);
         
         let isCompleted = false;
         let timeoutId;
         
         // Success handler
         const handleSuccess = () => {
           if (isCompleted) return;
           isCompleted = true;
           
           console.log('‚úÖ Form submission completed successfully');
           
           clearTimeout(timeoutId);
           
           // Cleanup
           setTimeout(() => {
             try {
               const formEl = document.getElementById(formId);
               const iframeEl = document.getElementById(iframeId);
               if (formEl && formEl.parentNode) document.body.removeChild(formEl);
               if (iframeEl && iframeEl.parentNode) document.body.removeChild(iframeEl);
             } catch (cleanupError) {
               console.warn('‚ö†Ô∏è Cleanup warning:', cleanupError);
             }
           }, 1000);
           
           resolve({
             success: true,
             message: 'ƒê√£ l∆∞u th√†nh c√¥ng!',
             method: 'pure_form',
             timestamp: new Date().toISOString()
           });
         };
         
         // Error handler
         const handleError = (errorMsg = 'Form submission failed') => {
           if (isCompleted) return;
           isCompleted = true;
           
           console.error('‚ùå Form submission error:', errorMsg);
           
           clearTimeout(timeoutId);
           
           setTimeout(() => {
             try {
               const formEl = document.getElementById(formId);
               const iframeEl = document.getElementById(iframeId);
               if (formEl && formEl.parentNode) document.body.removeChild(formEl);
               if (iframeEl && iframeEl.parentNode) document.body.removeChild(iframeEl);
             } catch (e) {}
           }, 1000);
           
           reject(new Error(errorMsg));
         };
         
         // Iframe load event
         iframe.addEventListener('load', function() {
           console.log('üì® Iframe loaded - form submitted');
           handleSuccess();
         });
         
         // Iframe error event
         iframe.addEventListener('error', function() {
           console.error('üì® Iframe error event');
           handleError('Iframe error during submission');
         });
         
         // Timeout fallback (12 gi√¢y)
         timeoutId = setTimeout(() => {
           console.log('‚è∞ Form submission timeout - assuming success');
           handleSuccess(); // Assume success on timeout
         }, 12000);
         
         // Submit form
         console.log('üì§ Submitting form to:', API_BASE_URL);
         try {
           form.submit();
           console.log('üì§ Form.submit() called successfully');
         } catch (submitError) {
           console.error('üì§ Form submit error:', submitError);
           handleError('Form submit failed: ' + submitError.message);
         }
       });
     }
   }

   // Utility functions
   const showLoading = (show = true) => {
     loading.classList.toggle('show', show);
   };

   const showToast = (message, type = 'default') => {
     toast.textContent = message;
     toast.className = `toast ${type}`;
     toast.classList.add('show');
     
     setTimeout(() => {
       toast.classList.remove('show');
     }, 3000);
   };

   const formatRecord = (record) => {
     const parts = [record.name, record.email, record.card].filter(Boolean);
     return parts.join(' | ');
   };

   const normalize = (str) => {
     if (!str) return '';
     return str.toString()
       .normalize('NFD')
       .replace(/[\u0300-\u036f]/g, '')
       .replace(/ƒë/g, 'd')
       .replace(/ƒê/g, 'd')
       .toLowerCase()
       .trim();
   };

   const highlightText = (text, query) => {
     if (!query || !text) return text || '(Kh√¥ng c√≥ t√™n)';
     const regex = new RegExp(`(${query.split(' ').filter(w => w.length > 1).join('|')})`, 'gi');
     return text.replace(regex, '<span class="highlight">$1</span>');
   };

   // Dropdown controls
   const openDropdown = () => {
     if (filteredResults.length > 0) {
       dropdownMenu.classList.add('show');
       searchInput.setAttribute('aria-expanded', 'true');
     }
   };

   const closeDropdown = () => {
     dropdownMenu.classList.remove('show');
     searchInput.setAttribute('aria-expanded', 'false');
     activeIndex = -1;
   };

   // Selection and preview
   const setSelected = (record) => {
     selectedRecord = record;
     updatePreview();
   };

   const updatePreview = () => {
     const inputValue = searchInput.value.trim();
     
     if (inputValue || selectedRecord) {
       previewSection.classList.add('show');
       
       previewInput.textContent = inputValue || '-';
       previewInput.className = inputValue ? 'preview-field-value' : 'preview-field-value empty';
       
       if (selectedRecord) {
         previewType.textContent = '‚úÖ ƒê√£ ch·ªçn t·ª´ danh s√°ch';
         previewType.className = 'preview-type selected';
         
         previewSelected.style.display = 'block';
         previewName.textContent = selectedRecord.name || '-';
         previewName.className = selectedRecord.name ? 'preview-field-value' : 'preview-field-value empty';
         
         previewEmail.textContent = selectedRecord.email || '-';
         previewEmail.className = selectedRecord.email ? 'preview-field-value' : 'preview-field-value empty';
         
         previewCard.textContent = selectedRecord.card || '-';
         previewCard.className = selectedRecord.card ? 'preview-field-value' : 'preview-field-value empty';
         
         submitBtn.className = 'btn ready';
         submitText.textContent = 'X√°c nh·∫≠n g·ª≠i';
         submitIcon.textContent = '‚úÖ';
         
       } else {
         previewType.textContent = '‚úèÔ∏è Nh·∫≠p t·ª± do';
         previewType.className = 'preview-type typed';
         previewSelected.style.display = 'none';
         
         submitBtn.className = 'btn';
         submitText.textContent = 'G·ª≠i th√¥ng tin';
         submitIcon.textContent = 'üì§';
       }
     } else {
       previewSection.classList.remove('show');
       submitBtn.className = 'btn';
       submitText.textContent = 'G·ª≠i th√¥ng tin';
       submitIcon.textContent = 'üì§';
     }
   };

   // Rendering
   const renderResults = (results, query = '') => {
     const fragment = document.createDocumentFragment();
     const maxResults = 50;
     
     results.slice(0, maxResults).forEach((record, index) => {
       const item = document.createElement('div');
       item.className = 'menu-item';
       item.setAttribute('data-index', index);
       
       const name = highlightText(record.name, query);
       const email = highlightText(record.email, query);
       const card = highlightText(record.card, query);
       
       const metaParts = [email, card].filter(p => p && p !== '(Kh√¥ng c√≥ t√™n)');
       const meta = metaParts.length > 0 ? metaParts.join(' ‚Ä¢ ') : '';
       
       item.innerHTML = `
         <div class="menu-item-name">${name}</div>
         ${meta ? `<div class="menu-item-meta">${meta}</div>` : ''}
       `;
       
       item.addEventListener('touchstart', (e) => {
         e.preventDefault();
         item.classList.add('active');
       });
       
       item.addEventListener('touchend', (e) => {
         e.preventDefault();
         item.classList.remove('active');
         selectRecord(record);
       });
       
       item.addEventListener('click', (e) => {
         e.preventDefault();
         selectRecord(record);
       });
       
       fragment.appendChild(item);
     });

     if (results.length > maxResults) {
       const moreItem = document.createElement('div');
       moreItem.className = 'menu-item';
       moreItem.style.fontStyle = 'italic';
       moreItem.style.textAlign = 'center';
       moreItem.innerHTML = `
         <div class="menu-item-name">... v√† ${results.length - maxResults} k·∫øt qu·∫£ kh√°c</div>
       `;
       fragment.appendChild(moreItem);
     }

     dropdownMenu.innerHTML = '';
     dropdownMenu.appendChild(fragment);
     
     badge.textContent = dataset.length ? `${results.length}/${dataset.length}` : '';
     
     if (results.length > 0) {
       openDropdown();
     } else {
       closeDropdown();
     }
   };

   const selectRecord = (record) => {
     setSelected(record);
     searchInput.value = formatRecord(record);
     closeDropdown();
     updatePreview();
     searchInput.focus();
   };

   // Search functionality
   const performSearch = (query) => {
     const normalizedQuery = normalize(query);
     
     if (searchCache.has(normalizedQuery)) {
       filteredResults = searchCache.get(normalizedQuery);
       renderResults(filteredResults, normalizedQuery);
       return;
     }

     if (!normalizedQuery) {
       filteredResults = dataset.slice(0, 20);
       searchCache.set(normalizedQuery, filteredResults);
       renderResults(filteredResults, normalizedQuery);
       return;
     }

     const scored = dataset.map(record => {
       let score = 0;
       const recordNorm = record.keyNorm;
       
       if (recordNorm === normalizedQuery) score += 1000;
       if (recordNorm.startsWith(normalizedQuery)) score += 500;
       if (recordNorm.includes(normalizedQuery)) score += 100;
       
       const queryWords = normalizedQuery.split(' ').filter(w => w.length > 1);
       queryWords.forEach(word => {
         if (recordNorm.includes(word)) score += 50;
         if (record.keywords && record.keywords.some(k => k.startsWith(word))) score += 25;
       });

       return { ...record, score };
     });

     filteredResults = scored
       .filter(record => record.score > 0)
       .sort((a, b) => b.score - a.score)
       .slice(0, 100);

     searchCache.set(normalizedQuery, filteredResults);
     
     if (searchCache.size > 20) {
       const firstKey = searchCache.keys().next().value;
       searchCache.delete(firstKey);
     }

     renderResults(filteredResults, normalizedQuery);
   };

   const debounce = (func, delay = 200) => {
     let timeoutId;
     return (...args) => {
       clearTimeout(timeoutId);
       timeoutId = setTimeout(() => func.apply(null, args), delay);
     };
   };

   const debouncedSearch = debounce(performSearch, 150);

   // Event handlers
   searchInput.addEventListener('input', (e) => {
     const query = e.target.value.trim();
     
     if (selectedRecord) {
       const currentFormatted = formatRecord(selectedRecord);
       if (e.target.value !== currentFormatted) {
         setSelected(null);
       }
     }
     
     updatePreview();
     debouncedSearch(query);
   });

   searchInput.addEventListener('focus', () => {
     if (filteredResults.length > 0) {
       openDropdown();
     }
   });

   searchInput.addEventListener('blur', () => {
     setTimeout(closeDropdown, 150);
   });

   searchInput.addEventListener('keydown', (e) => {
     if (!dropdownMenu.classList.contains('show')) return;
     
     const items = dropdownMenu.querySelectorAll('.menu-item[data-index]');
     const maxIndex = items.length - 1;
     
     switch (e.key) {
       case 'ArrowDown':
         e.preventDefault();
         activeIndex = Math.min(maxIndex, activeIndex + 1);
         updateActiveItem(items);
         break;
       case 'ArrowUp':
         e.preventDefault();
         activeIndex = Math.max(0, activeIndex - 1);
         updateActiveItem(items);
         break;
       case 'Enter':
         e.preventDefault();
         if (activeIndex >= 0 && activeIndex <= maxIndex) {
           const record = filteredResults[activeIndex];
           if (record) selectRecord(record);
         }
         break;
       case 'Escape':
         closeDropdown();
         break;
     }
   });

   const updateActiveItem = (items) => {
     items.forEach((item, index) => {
       item.classList.toggle('active', index === activeIndex);
       if (index === activeIndex) {
         item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
       }
     });
   };

   // üî• SUBMIT HANDLER v·ªõi Pure Form
   submitBtn.addEventListener('click', async () => {
     console.log('üî• SUBMIT BUTTON CLICKED!');
     
     if (isSubmitting) {
       console.log('‚ùå Already submitting, returning');
       return;
     }
     
     const inputValue = searchInput.value.trim();
     console.log('üìù Input value:', inputValue);
     
     if (!inputValue) {
       console.log('‚ùå No input value');
       showToast('Vui l√≤ng nh·∫≠p ho·∫∑c ch·ªçn th√¥ng tin', 'error');
       searchInput.focus();
       return;
     }

     console.log('‚úÖ Starting Pure Form submission...');
     console.log('üì§ Selected record:', selectedRecord);

     isSubmitting = true;
     submitBtn.disabled = true;
     submitText.textContent = 'ƒêang g·ª≠i...';
     submitIcon.textContent = '‚è≥';
     showLoading(true);

     try {
       console.log('üöÄ Calling Pure Form API...');
       const result = await SheetsAPI.saveResponse(inputValue, selectedRecord);
       console.log('üìã Pure Form Result:', result);
       
       if (result.success) {
         showToast('ƒê√£ ghi nh·∫≠n th√†nh c√¥ng!', 'success');
         
         // Reset form
         searchInput.value = '';
         setSelected(null);
         updatePreview();
         closeDropdown();
         performSearch('');
         
         setTimeout(() => searchInput.focus(), 500);
       } else {
         showToast('L·ªói: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'), 'error');
       }

     } catch (error) {
       console.error('üí• Submit error:', error);
       showToast('L·ªói: ' + error.message, 'error');
     } finally {
       console.log('üèÅ Submit process finished');
       isSubmitting = false;
       submitBtn.disabled = false;
       submitText.textContent = selectedRecord ? 'X√°c nh·∫≠n g·ª≠i' : 'G·ª≠i th√¥ng tin';
       submitIcon.textContent = selectedRecord ? '‚úÖ' : 'üì§';
       showLoading(false);
     }
   });

   // üî• ENHANCED INITIALIZATION v·ªõi retry logic
   const initializeApp = async () => {
     console.log('üöÄ Initializing app...');
     showLoading(true);
     badge.textContent = 'ƒêang t·∫£i...';

     let attempts = 0;
     const maxAttempts = 3;

     while (attempts < maxAttempts) {
       try {
         attempts++;
         console.log(`üì° Attempt ${attempts}/${maxAttempts} to load data`);
         
         const data = await SheetsAPI.getData();
         dataset = Array.isArray(data) ? data : [];
         
         showLoading(false);
         badge.textContent = dataset.length ? `0/${dataset.length}` : 'Kh√¥ng c√≥ d·ªØ li·ªáu';
         
         performSearch('');
         updatePreview();
         
         if (dataset.length > 0) {
           showToast(`ƒê√£ t·∫£i ${dataset.length} b·∫£n ghi`, 'success');
         } else {
           showToast('Kh√¥ng c√≥ d·ªØ li·ªáu trong sheet', 'warning');
         }
         
         searchInput.focus();
         console.log('‚úÖ App initialized successfully');
         return; // Success

       } catch (error) {
         console.error(`‚ùå Attempt ${attempts} failed:`, error);
         
         if (attempts >= maxAttempts) {
           showLoading(false);
           badge.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
           showToast(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error');
           
           // Show retry button
           const retryBtn = document.createElement('button');
           retryBtn.textContent = 'üîÑ Th·ª≠ l·∫°i';
           retryBtn.style.cssText = `
             position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background: #3b82f6; color: white; border: none; padding: 12px 24px;
             border-radius: 8px; font-size: 16px; cursor: pointer; z-index: 1000;
             box-shadow: 0 4px 12px rgba(0,0,0,0.15);
           `;
           retryBtn.onclick = () => {
             document.body.removeChild(retryBtn);
             initializeApp();
           };
           document.body.appendChild(retryBtn);
         } else {
           await new Promise(resolve => setTimeout(resolve, 2000 * attempts));
         }
       }
     }
   };

   // PWA behaviors
   let lastTouchEnd = 0;
   document.addEventListener('touchend', (e) => {
     const now = (new Date()).getTime();
     if (now - lastTouchEnd <= 300) {
       e.preventDefault();
     }
     lastTouchEnd = now;
   }, false);

   window.addEventListener('orientationchange', () => {
     if (dropdownMenu.classList.contains('show')) {
       setTimeout(() => {
         closeDropdown();
         openDropdown();
       }, 100);
     }
   });

   document.addEventListener('visibilitychange', () => {
     if (!document.hidden && searchInput) {
       setTimeout(() => searchInput.focus(), 100);
     }
   });

   // Start app
   if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initializeApp);
   } else {
     initializeApp();
   }

   // üî• Global error handler
   window.addEventListener('error', (event) => {
     console.error('üí• Global error:', event.error);
   });

   window.addEventListener('unhandledrejection', (event) => {
     console.error('üí• Unhandled promise rejection:', event.reason);
   });
 </script>
</body>
</html>