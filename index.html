<!doctype html>
<html lang="vi">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <meta name="apple-mobile-web-app-status-bar-style" content="default" />
 <meta name="theme-color" content="#111827" />
 <title>Food Card</title>
 <style>
   :root {
     --primary: #111827;
     --primary-light: #374151;
     --accent: #3b82f6;
     --success: #10b981;
     --warning: #f59e0b;
     --danger: #ef4444;
     --bg: #ffffff;
     --bg-soft: #f8fafc;
     --bg-card: #ffffff;
     --border: #e2e8f0;
     --border-focus: #3b82f6;
     --text: #0f172a;
     --text-soft: #64748b;
     --text-muted: #94a3b8;
     --text-xs: 14px;
     --text-sm: 16px;
     --text-base: 18px;
     --text-lg: 20px;
     --text-xl: 24px;
     --text-2xl: 28px;
     --tap-target: 48px;
     --space-1: 4px;
     --space-2: 8px;
     --space-3: 12px;
     --space-4: 16px;
     --space-6: 24px;
     --space-8: 32px;
     --container-padding: 16px;
     --card-padding: 20px;
     --input-padding: 16px;
     --radius-sm: 8px;
     --radius: 12px;
     --radius-lg: 16px;
     --radius-full: 9999px;
     --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
     --shadow: 0 4px 6px rgba(0,0,0,0.07);
     --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
   }

   *, *::before, *::after { box-sizing: border-box; }
   
   html {
     height: 100%;
     -webkit-text-size-adjust: 100%;
     -ms-text-size-adjust: 100%;
   }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
     background: var(--bg-soft);
     color: var(--text);
     margin: 0;
     min-height: 100%;
     font-size: var(--text-base);
     line-height: 1.5;
     padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
     overscroll-behavior-y: contain;
     -webkit-overflow-scrolling: touch;
   }

   .container {
     max-width: 100%;
     padding: var(--container-padding);
     margin: 0 auto;
   }

   .header {
     background: var(--primary);
     color: white;
     padding: var(--space-4) var(--container-padding);
     margin: calc(var(--container-padding) * -1) calc(var(--container-padding) * -1) var(--space-6);
     text-align: center;
   }
   
   .header h1 {
     margin: 0;
     font-size: var(--text-xl);
     font-weight: 600;
     letter-spacing: -0.025em;
   }

   .card {
     background: var(--bg-card);
     border-radius: var(--radius-lg);
     padding: var(--card-padding);
     box-shadow: var(--shadow);
     border: 1px solid var(--border);
     margin-bottom: var(--space-4);
   }

   .section-title {
     font-size: var(--text-lg);
     font-weight: 600;
     margin-bottom: var(--space-4);
     color: var(--text);
   }

   /* 🔥 TYPE SELECTOR */
   .type-selector {
     display: grid;
     grid-template-columns: repeat(3, 1fr);
     gap: var(--space-3);
     margin-bottom: var(--space-6);
   }

   .type-option {
     position: relative;
     cursor: pointer;
   }

   .type-input {
     position: absolute;
     opacity: 0;
     pointer-events: none;
   }

   .type-label {
     display: flex;
     flex-direction: column;
     align-items: center;
     padding: var(--space-4);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     background: var(--bg);
     transition: all 0.2s ease;
     min-height: 80px;
     justify-content: center;
   }

   .type-input:checked + .type-label {
     border-color: var(--accent);
     background: #f0f9ff;
     color: var(--accent);
   }

   .type-emoji {
     font-size: 24px;
     margin-bottom: var(--space-1);
   }

   .type-text {
     font-size: var(--text-sm);
     font-weight: 600;
   }

   /* 🔥 SEARCH SECTION */
   .search-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .search-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .search-input-group {
     display: flex;
     gap: var(--space-3);
     margin-bottom: var(--space-4);
   }

   .search-input-wrapper {
     flex: 1;
     position: relative;
     display: flex;
     align-items: center;
     background: var(--bg);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-2);
     transition: all 0.2s ease;
     min-height: var(--tap-target);
   }

   .search-input-wrapper:focus-within {
     border-color: var(--border-focus);
     box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
   }

   .search-input {
     flex: 1;
     border: none;
     outline: none;
     background: transparent;
     font-size: var(--text-base);
     padding: var(--space-3);
     color: var(--text);
     font-size: 16px;
   }

   .search-input::placeholder {
     color: var(--text-muted);
   }

   .search-btn {
     background: var(--accent);
     color: white;
     border: none;
     border-radius: var(--radius);
     padding: 0 var(--space-4);
     font-size: var(--text-sm);
     font-weight: 600;
     min-height: var(--tap-target);
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     gap: var(--space-2);
     white-space: nowrap;
   }

   .search-btn:hover {
     background: #2563eb;
   }

   .search-btn:active {
     transform: scale(0.98);
   }

   .search-btn:disabled {
     opacity: 0.5;
     cursor: not-allowed;
     transform: none;
   }

   /* 🔥 SELECTED INFO DISPLAY */
   .selected-info {
     background: #f0f9ff;
     border: 2px solid var(--accent);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-4);
     display: none;
   }

   .selected-info.show {
     display: block;
     animation: slideIn 0.3s ease;
   }

   .selected-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: var(--space-3);
   }

   .selected-title {
     font-size: var(--text-sm);
     font-weight: 600;
     color: var(--accent);
   }

   .clear-btn {
     background: var(--danger);
     color: white;
     border: none;
     border-radius: var(--radius-sm);
     padding: var(--space-1) var(--space-3);
     font-size: var(--text-xs);
     font-weight: 600;
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .clear-btn:active {
     transform: scale(0.95);
   }

   .selected-details {
     display: flex;
     flex-direction: column;
     gap: var(--space-2);
   }

   .selected-field {
     display: flex;
     justify-content: space-between;
     align-items: center;
   }

   .selected-field-label {
     font-size: var(--text-sm);
     color: var(--text-soft);
     font-weight: 500;
   }

   .selected-field-value {
     font-size: var(--text-sm);
     color: var(--text);
     font-weight: 600;
   }

   /* 🔥 MANUAL ENTRY OPTION */
   .manual-entry-section {
     border: 1px dashed var(--border);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-4);
     background: #fefce8;
     display: none;
   }

   .manual-entry-section.show {
     display: block;
     animation: fadeIn 0.3s ease;
   }

   .checkbox-wrapper {
     display: flex;
     align-items: center;
     gap: var(--space-3);
     margin-bottom: var(--space-4);
   }

   .checkbox {
     width: 20px;
     height: 20px;
     border: 2px solid var(--border);
     border-radius: 4px;
     cursor: pointer;
     position: relative;
     transition: all 0.2s ease;
   }

   .checkbox input {
     opacity: 0;
     position: absolute;
     pointer-events: none;
   }

   .checkbox input:checked + .checkmark {
     background: var(--accent);
     border-color: var(--accent);
   }

   .checkmark {
     width: 100%;
     height: 100%;
     border-radius: 4px;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     font-size: 12px;
   }

   .checkbox input:checked + .checkmark::after {
     content: '✓';
   }

   .checkbox-label {
     font-weight: 600;
     color: #92400e;
     cursor: pointer;
   }

   .manual-input {
     width: 100%;
     padding: var(--space-3);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     font-size: var(--text-base);
     transition: border-color 0.2s ease;
     display: none;
   }

   .manual-input.show {
     display: block;
   }

   .manual-input:focus {
     outline: none;
     border-color: var(--accent);
   }

   /* 🔥 SEARCH POPUP */
   .search-popup {
     position: fixed;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background: rgba(0, 0, 0, 0.5);
     z-index: 100;
     display: none;
     align-items: center;
     justify-content: center;
     padding: var(--container-padding);
   }

   .search-popup.show {
     display: flex;
     animation: fadeIn 0.3s ease;
   }

   .popup-content {
     background: var(--bg-card);
     border-radius: var(--radius-lg);
     box-shadow: var(--shadow-lg);
     width: 100%;
     max-width: 500px;
     max-height: 70vh;
     overflow: hidden;
     display: flex;
     flex-direction: column;
   }

   .popup-header {
     padding: var(--space-4);
     border-bottom: 1px solid var(--border);
     display: flex;
     justify-content: space-between;
     align-items: center;
   }

   .popup-title {
     font-size: var(--text-lg);
     font-weight: 600;
     color: var(--text);
   }

   .popup-close {
     background: none;
     border: none;
     font-size: var(--text-xl);
     cursor: pointer;
     color: var(--text-muted);
     padding: var(--space-2);
     line-height: 1;
   }

   .popup-body {
     padding: var(--space-4);
     overflow-y: auto;
     flex: 1;
   }

   .search-results {
     display: flex;
     flex-direction: column;
     gap: var(--space-2);
   }

   .result-item {
     padding: var(--space-4);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     cursor: pointer;
     transition: all 0.2s ease;
     background: var(--bg);
   }

   .result-item:hover {
     border-color: var(--accent);
     background: #f0f9ff;
   }

   .result-item:active {
     transform: scale(0.98);
   }

   .result-name {
     font-weight: 600;
     font-size: var(--text-base);
     color: var(--text);
     margin-bottom: var(--space-1);
   }

   .result-meta {
     font-size: var(--text-sm);
     color: var(--text-soft);
     line-height: 1.4;
   }

   .no-results {
     text-align: center;
     padding: var(--space-8);
     color: var(--text-muted);
   }

   .no-results-icon {
     font-size: var(--text-2xl);
     margin-bottom: var(--space-3);
   }

   /* 🔥 REASON SELECTOR */
   .reason-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .reason-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .reason-options {
     display: flex;
     flex-direction: column;
     gap: var(--space-3);
     margin-bottom: var(--space-6);
   }

   .reason-option {
     display: flex;
     align-items: center;
     gap: var(--space-3);
     padding: var(--space-3);
     border: 2px solid var(--border);
     border-radius: var(--radius);
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .reason-option:hover {
     border-color: var(--accent);
   }

   .reason-option.selected {
     border-color: var(--accent);
     background: #f0f9ff;
   }

   .reason-icon {
     font-size: 20px;
     width: 24px;
     text-align: center;
   }

   .reason-text {
     font-weight: 500;
     flex: 1;
   }

   /* 🔥 PREVIEW SECTION */
   .preview-section {
     background: var(--bg-soft);
     border: 1px solid var(--border);
     border-radius: var(--radius);
     padding: var(--space-4);
     margin-bottom: var(--space-6);
     display: none;
   }

   .preview-section.show {
     display: block;
     animation: slideIn 0.3s ease;
   }

   @keyframes slideIn {
     from { opacity: 0; transform: translateY(-10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   @keyframes fadeIn {
     from { opacity: 0; }
     to { opacity: 1; }
   }

   .preview-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: var(--space-3);
     padding-bottom: var(--space-2);
     border-bottom: 1px solid var(--border);
   }

   .preview-label {
     font-size: var(--text-sm);
     font-weight: 600;
     color: var(--text);
   }

   .preview-status {
     font-size: var(--text-xs);
     padding: var(--space-1) var(--space-2);
     border-radius: var(--radius-sm);
     font-weight: 500;
     background: #dcfce7;
     color: #166534;
   }

   .preview-content {
     display: flex;
     flex-direction: column;
     gap: var(--space-3);
   }

   .preview-item {
     display: flex;
     justify-content: space-between;
     align-items: flex-start;
     gap: var(--space-3);
   }

   .preview-field-label {
     font-size: var(--text-sm);
     color: var(--text-soft);
     font-weight: 500;
     min-width: 80px;
     flex-shrink: 0;
   }

   .preview-field-value {
     font-size: var(--text-sm);
     color: var(--text);
     font-weight: 500;
     flex: 1;
     text-align: right;
     word-break: break-word;
   }

   .preview-field-value.empty {
     color: var(--text-muted);
     font-style: italic;
   }

   /* 🔥 SUBMIT BUTTON */
   .submit-section {
     opacity: 0.5;
     pointer-events: none;
     transition: all 0.3s ease;
   }

   .submit-section.enabled {
     opacity: 1;
     pointer-events: auto;
   }

   .btn {
     width: 100%;
     background: var(--primary);
     color: white;
     border: none;
     border-radius: var(--radius);
     padding: var(--input-padding);
     font-size: var(--text-base);
     font-weight: 600;
     min-height: var(--tap-target);
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: var(--space-2);
     touch-action: manipulation;
   }

   .btn:active {
     background: var(--primary-light);
     transform: scale(0.98);
   }

   .btn:disabled {
     opacity: 0.6;
     cursor: not-allowed;
     transform: none;
   }

   .btn.ready {
     background: var(--success);
   }

   .btn.ready:active {
     background: #059669;
   }

   /* 🔥 TOAST */
   .toast {
     position: fixed;
     bottom: var(--space-6);
     left: var(--container-padding);
     right: var(--container-padding);
     background: var(--primary);
     color: white;
     padding: var(--input-padding);
     border-radius: var(--radius);
     box-shadow: var(--shadow-lg);
     transform: translateY(100px);
     opacity: 0;
     transition: all 0.3s ease;
     z-index: 200;
     text-align: center;
     font-weight: 500;
   }

   .toast.show {
     transform: translateY(0);
     opacity: 1;
   }

   .toast.success {
     background: var(--success);
   }

   .toast.error {
     background: var(--danger);
   }

   .toast.warning {
     background: var(--warning);
   }

   /* 🔥 LOADING INDICATOR */
   .loading {
     width: 16px;
     height: 16px;
     border: 2px solid currentColor;
     border-top-color: transparent;
     border-radius: 50%;
     animation: spin 0.8s linear infinite;
     display: none;
   }

   .loading.show { display: block; }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }

   /* Mobile optimizations */
   input, select, textarea {
     font-size: 16px !important;
   }

   input, textarea {
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
   }

   button, .btn, .type-label, .reason-option, .result-item {
     min-height: 48px;
   }

   .btn, .type-label, .reason-option, .result-item {
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
   }

   ::-webkit-scrollbar {
     width: 0px;
     background: transparent;
   }
 </style>
</head>
<body>
 <div class="container">
   <div class="header">
     <h1>🏫 Food Card</h1>
   </div>

   <!-- 🔥 STEP 1: TYPE SELECTION -->
   <div class="card">
     <div class="section-title">1. Chọn đối tượng | Select Type</div>
     <div class="type-selector">
       <div class="type-option">
         <input type="radio" name="userType" value="staff" id="typeStaff" class="type-input">
         <label for="typeStaff" class="type-label">
           <div class="type-emoji">👨‍💼</div>
           <div class="type-text">Staff</div>
         </label>
       </div>
       <div class="type-option">
         <input type="radio" name="userType" value="student" id="typeStudent" class="type-input">
         <label for="typeStudent" class="type-label">
           <div class="type-emoji">🎓</div>
           <div class="type-text">Student</div>
         </label>
       </div>
       <div class="type-option">
         <input type="radio" name="userType" value="teacher" id="typeTeacher" class="type-input">
         <label for="typeTeacher" class="type-label">
           <div class="type-emoji">👨‍🏫</div>
           <div class="type-text">Teacher</div>
         </label>
       </div>
     </div>
   </div>

   <!-- 🔥 STEP 2: SEARCH WITH POPUP -->
   <div class="card">
     <div class="search-section" id="searchSection">
       <div class="section-title">2. Tìm kiếm thông tin | Search </Search></div>
       
       <!-- 🔥 SEARCH INPUT -->
       <div class="search-input-group">
         <div class="search-input-wrapper">
           <input 
             id="searchInput"
             class="search-input" 
             type="text" 
             placeholder="Nhập tên, email hoặc mã thẻ..."
             autocomplete="off"
             autocapitalize="off"
             autocorrect="off"
             spellcheck="false"
             disabled
           />
         </div>
         <button id="searchBtn" class="search-btn" disabled>
           <div id="searchLoading" class="loading"></div>
           <span id="searchBtnText">🔍 Search</span>
         </button>
       </div>

       <!-- 🔥 SELECTED INFO DISPLAY -->
       <div class="selected-info" id="selectedInfo">
         <div class="selected-header">
           <span class="selected-title">✅ Đã chọn | Selected:</span>
           <button id="clearBtn" class="clear-btn">Xóa</button>
         </div>
         <div class="selected-details">
           <div class="selected-field">
             <span class="selected-field-label">👤 Tên| Name:</span>
             <span id="selectedName" class="selected-field-value">-</span>
           </div>
           <div class="selected-field">
             <span class="selected-field-label">📧 Email| Email:</span>
             <span id="selectedEmail" class="selected-field-value">-</span>
           </div>
           <div class="selected-field">
             <span class="selected-field-label">💳 Thẻ| Card:</span>
             <span id="selectedCard" class="selected-field-value">-</span>
           </div>
         </div>
       </div>

       <!-- 🔥 MANUAL ENTRY OPTION -->
       <div class="manual-entry-section" id="manualEntrySection">
         <div class="checkbox-wrapper">
           <label class="checkbox">
             <input type="checkbox" id="manualCheckbox">
             <div class="checkmark"></div>
           </label>
           <label for="manualCheckbox" class="checkbox-label">
             Không có trong danh sách - Tự nhập thông tin
           </label>
         </div>
         <input 
           type="text" 
           id="manualInput" 
           class="manual-input" 
           placeholder="Nhập tên đầy đủ..."
         />
       </div>
     </div>
   </div>

   <!-- 🔥 STEP 3: REASON SELECTION -->
   <div class="card">
     <div class="reason-section" id="reasonSection">
       <div class="section-title">3. Chọn lý do| Reason Selection</div>
       <div class="reason-options">
         <div class="reason-option" data-reason="forgot_card">
           <div class="reason-icon">🤦‍♂️</div>
           <div class="reason-text">Quên mang thẻ | Forgot card</div>
         </div>
         <div class="reason-option" data-reason="broken_card">
           <div class="reason-icon">💳</div>
           <div class="reason-text">Thẻ lỗi | Broken card</div>
         </div>
         <div class="reason-option" data-reason="no_card">
           <div class="reason-icon">❓</div>
           <div class="reason-text">Chưa có thẻ | No card</div>
         </div>
       </div>
     </div>
   </div>

   <!-- 🔥 PREVIEW -->
   <div class="preview-section" id="previewSection">
     <div class="preview-header">
       <span class="preview-label">Thông tin của bạn| Your information</span>
       <span class="preview-status">✅</span>
     </div>
     <div class="preview-content">
       <div class="preview-item">
         <div class="preview-field-label">👤 Loại| Type:</div>
         <div id="previewType" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">📝 Tên| Name:</div>
         <div id="previewName" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">📧 Email| Email:</div>
         <div id="previewEmail" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">💳 Thẻ| Card:</div>
         <div id="previewCard" class="preview-field-value">-</div>
       </div>
       <div class="preview-item">
         <div class="preview-field-label">❓ Lý do| Reason:</div>
         <div id="previewReason" class="preview-field-value">-</div>
       </div>
     </div>
   </div>

   <!-- 🔥 SUBMIT -->
   <div class="submit-section" id="submitSection">
     <button id="submitBtn" class="btn">
       <span id="submitText">SEND</span>
       <span id="submitIcon">🚀</span>
     </button>
   </div>
 </div>

 <!-- 🔥 SEARCH POPUP -->
 <div class="search-popup" id="searchPopup">
   <div class="popup-content">
     <div class="popup-header">
       <div class="popup-title">🔍 Kết quả tìm kiếm | Results</div>
       <button id="popupClose" class="popup-close">×</button>
     </div>
     <div class="popup-body">
       <div id="searchResults" class="search-results">
         <!-- Search results will be populated here -->
       </div>
     </div>
   </div>
 </div>

 <div id="toast" class="toast"></div>

 <script>
   // 🔥 CONFIGURATION
   const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzYUn8dsVMCUpadHujS-8Brtt-s8l8xmyU2SPMR1qJXyHQ7LGjWp4qPY7k-KEjirAGvAg/exec';
   
   // Global state
   let selectedType = null;
   let selectedRecord = null;
   let isManualEntry = false;
   let selectedReason = null;
   let isSubmitting = false;
   let isSearching = false;

   // DOM elements
   const searchSection = document.getElementById('searchSection');
   const searchInput = document.getElementById('searchInput');
   const searchBtn = document.getElementById('searchBtn');
   const searchLoading = document.getElementById('searchLoading');
   const searchBtnText = document.getElementById('searchBtnText');
   const selectedInfo = document.getElementById('selectedInfo');
   const selectedName = document.getElementById('selectedName');
   const selectedEmail = document.getElementById('selectedEmail');
   const selectedCard = document.getElementById('selectedCard');
   const clearBtn = document.getElementById('clearBtn');
   const manualEntrySection = document.getElementById('manualEntrySection');
   const manualCheckbox = document.getElementById('manualCheckbox');
   const manualInput = document.getElementById('manualInput');
   const reasonSection = document.getElementById('reasonSection');
   const previewSection = document.getElementById('previewSection');
   const submitSection = document.getElementById('submitSection');
   const submitBtn = document.getElementById('submitBtn');
   const submitText = document.getElementById('submitText');
   const submitIcon = document.getElementById('submitIcon');
   const toast = document.getElementById('toast');
   const searchPopup = document.getElementById('searchPopup');
   const popupClose = document.getElementById('popupClose');
   const searchResults = document.getElementById('searchResults');

   // Preview elements
   const previewType = document.getElementById('previewType');
   const previewName = document.getElementById('previewName');
   const previewEmail = document.getElementById('previewEmail');
   const previewCard = document.getElementById('previewCard');
   const previewReason = document.getElementById('previewReason');

   // 🔥 API CLASS
   class SheetsAPI {
     static async searchByType(userType, query, limit = 20) {
       try {
         if (!query || query.length < 2) {
           return { results: [], count: 0 };
         }
         
         return new Promise((resolve, reject) => {
           const callbackName = 'search_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
           
           console.log(`🔍 Searching ${userType}:`, query);
           
           const script = document.createElement('script');
           script.src = `${API_BASE_URL}?action=searchByType&type=${userType}&query=${encodeURIComponent(query)}&limit=${limit}&callback=${callbackName}&t=${Date.now()}`;
           script.id = callbackName;
           
           window[callbackName] = function(data) {
             console.log('✅ Search results:', data);
             
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             
             if (data && data.error) {
               reject(new Error(data.error));
             } else {
               resolve(data);
             }
           };
           
           script.onerror = function() {
             delete window[callbackName];
             const scriptEl = document.getElementById(callbackName);
             if (scriptEl) document.head.removeChild(scriptEl);
             reject(new Error('Search failed'));
           };
           
           document.head.appendChild(script);
           
           setTimeout(() => {
             if (window[callbackName]) {
               delete window[callbackName];
               const scriptEl = document.getElementById(callbackName);
               if (scriptEl) document.head.removeChild(scriptEl);
               reject(new Error('Search timeout'));
             }
           }, 10000);
         });
       } catch (error) {
         console.error('Search error:', error);
         throw error;
       }
     }
     
     static async submitCheckin(data) {
       return new Promise((resolve, reject) => {
         console.log('🔥 Submitting checkin:', data);
         
         const timestamp = Date.now();
         const formId = 'checkin_form_' + timestamp;
         const iframeId = 'checkin_iframe_' + timestamp;
         
         const form = document.createElement('form');
         form.id = formId;
         form.method = 'POST';
         form.action = API_BASE_URL;
         form.target = iframeId;
         form.style.display = 'none';
         
         const iframe = document.createElement('iframe');
         iframe.id = iframeId;
         iframe.name = iframeId;
         iframe.style.display = 'none';
         
         const dataInput = document.createElement('input');
         dataInput.type = 'hidden';
         dataInput.name = 'data';
         dataInput.value = JSON.stringify({
           action: 'checkin',
           ...data,
           timestamp: new Date().toISOString()
         });
         
         form.appendChild(dataInput);
         document.body.appendChild(form);
         document.body.appendChild(iframe);
         
         let isCompleted = false;
         
         iframe.addEventListener('load', function() {
           if (!isCompleted) {
             isCompleted = true;
             setTimeout(() => {
               try {
                 if (form.parentNode) document.body.removeChild(form);
                 if (iframe.parentNode) document.body.removeChild(iframe);
               } catch (e) {}
             }, 1000);
             resolve({ success: true, message: 'Success!' });
           }
         });
         
         setTimeout(() => {
           if (!isCompleted) {
             isCompleted = true;
             try {
               if (form.parentNode) document.body.removeChild(form);
               if (iframe.parentNode) document.body.removeChild(iframe);
             } catch (e) {}
             resolve({ success: true, message: 'Success!' });
           }
         }, 10000);
         
         form.submit();
       });
     }
   }

   // 🔥 UTILITY FUNCTIONS
   const showToast = (message, type = 'default') => {
     toast.textContent = message;
     toast.className = `toast ${type}`;
     toast.classList.add('show');
     
     setTimeout(() => {
       toast.classList.remove('show');
     }, 3000);
   };

   const highlightText = (text, query) => {
     if (!query || !text) return text || '(Không có tên)';
     const regex = new RegExp(`(${query.split(' ').filter(w => w.length > 1).join('|')})`, 'gi');
     return text.replace(regex, '<span style="background: #fef3c7; font-weight: 600;">$1</span>');
   };

   // 🔥 UI STATE MANAGEMENT
   const enableSection = (section, enabled = true) => {
     if (enabled) {
       section.classList.add('enabled');
       const inputs = section.querySelectorAll('input, button');
       inputs.forEach(input => input.disabled = false);
     } else {
       section.classList.remove('enabled');
       const inputs = section.querySelectorAll('input, button');
       inputs.forEach(input => input.disabled = true);
     }
   };

   const updatePreview = () => {
     const hasPersonInfo = selectedRecord || (isManualEntry && manualInput.value.trim());
     const hasData = selectedType && hasPersonInfo && selectedReason;
     
     if (hasData) {
       previewSection.classList.add('show');
       
       // Update preview content
       previewType.textContent = getTypeLabel(selectedType);
       
       if (selectedRecord) {
         previewName.textContent = selectedRecord.name || '-';
         previewEmail.textContent = selectedRecord.email || '-';
         previewCard.textContent = `${selectedRecord.card || '-'} ${selectedRecord.card_number ? '/ ' + selectedRecord.card_number : ''}`.trim();
       } else if (isManualEntry) {
         previewName.textContent = manualInput.value.trim() || '-';
         previewEmail.textContent = '-';
         previewCard.textContent = '-';
       }
       
       previewReason.textContent = getReasonLabel(selectedReason);
       
       // Enable submit
       enableSection(submitSection, true);
       submitBtn.classList.add('ready');
     } else {
       previewSection.classList.remove('show');
       enableSection(submitSection, false);
       submitBtn.classList.remove('ready');
     }
   };

   const getTypeLabel = (type) => {
     const labels = {
       staff: '👨‍💼 Staff',
       student: '🎓 Student', 
       teacher: '👨‍🏫 Teacher'
     };
     return labels[type] || type;
   };

   const getReasonLabel = (reason) => {
     const labels = {
       forgot_card: '🤦‍♂️ Quên mang thẻ',
       broken_card: '💳 Thẻ lỗi',
       no_card: '❓ Chưa có thẻ'
     };
     return labels[reason] || reason;
   };

   // 🔥 SEARCH FUNCTIONALITY
   const performSearch = async () => {
     const query = searchInput.value.trim();
     
     if (!selectedType) {
       showToast('Vui lòng chọn loại người dùng trước', 'error');
       return;
     }

     if (!query || query.length < 2) {
       showToast('Vui lòng nhập ít nhất 2 ký tự', 'error');
       return;
     }

     if (isSearching) return;

     try {
       isSearching = true;
       searchBtn.disabled = true;
       searchLoading.classList.add('show');
       searchBtnText.textContent = 'Searching...';

       const result = await SheetsAPI.searchByType(selectedType, query);
       
       // Show popup với results
       showSearchPopup(result.results || [], query);
       
       // Show manual entry option if no results
       if (!result.results || result.results.length === 0) {
         manualEntrySection.classList.add('show');
       } else {
         manualEntrySection.classList.remove('show');
         manualCheckbox.checked = false;
         isManualEntry = false;
         manualInput.classList.remove('show');
       }
       
     } catch (error) {
       console.error('Search error:', error);
       showToast('Search error: ' + error.message, 'error');
       
       // Show manual entry on error
       manualEntrySection.classList.add('show');
     } finally {
       isSearching = false;
       searchBtn.disabled = false;
       searchLoading.classList.remove('show');
       searchBtnText.textContent = '🔍 Search';
     }
   };

   // 🔥 SEARCH POPUP FUNCTIONALITY
   const showSearchPopup = (results, query) => {
     // Clear previous results
     searchResults.innerHTML = '';
     
     if (results.length === 0) {
       // No results
       const noResults = document.createElement('div');
       noResults.className = 'no-results';
       noResults.innerHTML = `
         <div class="no-results-icon">😕</div>
         <div>Không tìm thấy kết quả cho "${query}"</div>
         <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
           Bạn có thể tự nhập thông tin bên dưới
         </div>
       `;
       searchResults.appendChild(noResults);
     } else {
       // Show results
       results.forEach(record => {
         const resultItem = document.createElement('div');
         resultItem.className = 'result-item';
         
         const name = highlightText(record.name, query);
         const email = highlightText(record.email, query);
         const card = highlightText(record.card, query);
         const staffNumber = highlightText(record.staff_number, query);
         const cardNumber = highlightText(record.card_number, query);
         
         // Build meta info
         const metaParts = [];
         if (email) metaParts.push(`📧 ${email}`);
         if (card) metaParts.push(`💳 ${card}`);
         if (staffNumber) metaParts.push(`👤 ${staffNumber}`);
         if (cardNumber) metaParts.push(`🆔 ${cardNumber}`);
         
         const meta = metaParts.join(' • ');
         
         resultItem.innerHTML = `
           <div class="result-name">${name}</div>
           ${meta ? `<div class="result-meta">${meta}</div>` : ''}
         `;
         
         resultItem.addEventListener('click', () => {
           selectRecord(record);
           closeSearchPopup();
         });
         
         searchResults.appendChild(resultItem);
       });
     }
     
     // Show popup
     searchPopup.classList.add('show');
   };

   const closeSearchPopup = () => {
     searchPopup.classList.remove('show');
   };

   const selectRecord = (record) => {
     selectedRecord = record;
     
     // Update selected info display
     selectedName.textContent = record.name || '-';
     selectedEmail.textContent = record.email || '-';
     selectedCard.textContent = `${record.card || '-'} ${record.card_number ? '/ ' + record.card_number : ''}`.trim();
     
     // Show selected info
     selectedInfo.classList.add('show');
     
     // Hide manual entry
     manualEntrySection.classList.remove('show');
     manualCheckbox.checked = false;
     isManualEntry = false;
     manualInput.classList.remove('show');
     
     // Enable reason section
     enableSection(reasonSection, true);
     updatePreview();
   };

   const clearSelection = () => {
     selectedRecord = null;
     selectedInfo.classList.remove('show');
     
     // Reset reason selection if no manual entry
     if (!isManualEntry) {
       enableSection(reasonSection, false);
       selectedReason = null;
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
     }
     
     updatePreview();
   };

   // 🔥 EVENT LISTENERS

   // Type selection
   document.querySelectorAll('input[name="userType"]').forEach(radio => {
     radio.addEventListener('change', (e) => {
       selectedType = e.target.value;
       console.log('Selected type:', selectedType);
       
       // Enable search section
       enableSection(searchSection, true);
       searchInput.focus();
       
       // Reset everything else
       clearSelection();
       manualEntrySection.classList.remove('show');
       manualCheckbox.checked = false;
       isManualEntry = false;
       manualInput.classList.remove('show');
       
       // Reset subsequent sections
       enableSection(reasonSection, false);
       enableSection(submitSection, false);
       selectedReason = null;
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
       
       updatePreview();
     });
   });

   // Search button
   searchBtn.addEventListener('click', performSearch);

   // Enter key in search input
   searchInput.addEventListener('keydown', (e) => {
     if (e.key === 'Enter') {
       e.preventDefault();
       performSearch();
     }
   });

   // Clear selection button
   clearBtn.addEventListener('click', clearSelection);

   // Manual entry checkbox
   manualCheckbox.addEventListener('change', (e) => {
     isManualEntry = e.target.checked;
     
     if (isManualEntry) {
       manualInput.classList.add('show');
       manualInput.focus();
       clearSelection(); // Clear any selected record
       enableSection(reasonSection, true);
     } else {
       manualInput.classList.remove('show');
       manualInput.value = '';
       if (!selectedRecord) {
         enableSection(reasonSection, false);
         selectedReason = null;
         document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
       }
     }
     
     updatePreview();
   });

   // Manual input
   manualInput.addEventListener('input', () => {
     updatePreview();
   });

   // Popup close
   popupClose.addEventListener('click', closeSearchPopup);
   
   // Click outside popup to close
   searchPopup.addEventListener('click', (e) => {
     if (e.target === searchPopup) {
       closeSearchPopup();
     }
   });

   // Reason selection
   document.querySelectorAll('.reason-option').forEach(option => {
     option.addEventListener('click', () => {
       // Remove previous selection
       document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
       
       // Select current
       option.classList.add('selected');
       selectedReason = option.dataset.reason;
       
       console.log('Selected reason:', selectedReason);
       updatePreview();
     });
   });

   // Submit button
   submitBtn.addEventListener('click', async () => {
     if (isSubmitting) return;
     
     if (!selectedType || !selectedReason) {
       showToast('Vui lòng hoàn thành tất cả thông tin', 'error');
       return;
     }

     if (!selectedRecord && !isManualEntry) {
       showToast('Vui lòng chọn người hoặc đánh dấu "Tự nhập thông tin"', 'error');
       return;
     }

     if (isManualEntry && !manualInput.value.trim()) {
       showToast('Vui lòng nhập tên', 'error');
       manualInput.focus();
       return;
     }

     isSubmitting = true;
     submitBtn.disabled = true;
     submitText.textContent = 'Đang gửi...';
     submitIcon.textContent = '⏳';

     try {
       const checkinData = {
         userType: selectedType,
         reason: selectedReason,
         timestamp: new Date().toISOString()
       };

       if (selectedRecord) {
         checkinData.selectedRecord = selectedRecord;
         checkinData.inputMethod = 'selected';
       } else if (isManualEntry) {
         checkinData.manualName = manualInput.value.trim();
         checkinData.inputMethod = 'manual';
       }

       console.log('Submitting checkin data:', checkinData);
       
       const result = await SheetsAPI.submitCheckin(checkinData);
       
       if (result.success) {
         showToast(result.message, 'success');
         
         // Reset form
         resetForm();
       } else {
         showToast('Lỗi: ' + (result.error || 'Không xác định'), 'error');
       }

     } catch (error) {
       console.error('Submit error:', error);
       showToast('Lỗi: ' + error.message, 'error');
     } finally {
       isSubmitting = false;
       submitBtn.disabled = false;
       submitText.textContent = 'SEND';
       submitIcon.textContent = '🚀';
     }
   });

   // 🔥 RESET FORM
   const resetForm = () => {
     // Reset type selection
     document.querySelectorAll('input[name="userType"]').forEach(radio => radio.checked = false);
     selectedType = null;
     
     // Reset search
     searchInput.value = '';
     searchInput.disabled = true;
     clearSelection();
     
     // Reset manual entry
     manualEntrySection.classList.remove('show');
     manualCheckbox.checked = false;
     manualInput.classList.remove('show');
     manualInput.value = '';
     isManualEntry = false;
     
     // Reset reason
     document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
     selectedReason = null;
     
     // Reset sections
     enableSection(searchSection, false);
     enableSection(reasonSection, false);
     enableSection(submitSection, false);
     
     // Reset preview
     previewSection.classList.remove('show');
     submitBtn.classList.remove('ready');
     
     // Close popup
     closeSearchPopup();
   };

   // 🔥 INITIALIZATION
   const initializeApp = () => {
     console.log('🚀 Initializing check-in app...');
     
     // Set initial state
     enableSection(searchSection, false);
     enableSection(reasonSection, false);
     enableSection(submitSection, false);
     
     showToast('Chọn đối tượng', 'success');
   };

   // Start app
   if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initializeApp);
   } else {
     initializeApp();
   }

   // PWA behaviors
   let lastTouchEnd = 0;
   document.addEventListener('touchend', (e) => {
     const now = Date.now();
     if (now - lastTouchEnd <= 300) {
       e.preventDefault();
     }
     lastTouchEnd = now;
   }, false);

   // Global error handling
   window.addEventListener('error', (event) => {
     console.error('💥 Global error:', event.error);
   });

   window.addEventListener('unhandledrejection', (event) => {
     console.error('💥 Unhandled promise rejection:', event.reason);
   });
 </script>
</body>
</html>